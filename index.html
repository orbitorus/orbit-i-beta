<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Satellite Constellations Overview</title>
  <style>
    body { margin: 0; background: black; font-family: sans-serif; color: white; }
    #top-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background: rgba(40, 40, 40, 0.95);
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 0 20px;
      z-index: 20;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    #top-banner button, #top-banner select {
      padding: 6px 14px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }
    #top-banner button {
      background-color: #1e90ff;
      color: white;
    }
    #top-banner button:hover:not(:disabled) {
      background-color: #63b3ff;
    }
    #chart { width: 100%; height: 100vh; margin-top: 50px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/globe.gl"></script>
</head>
<body>

<div id="top-banner">
  <span>Constellation Visualization</span>
  <select id="constellation-select">
    <option value="all" selected>All Active Satellites</option>
    <option value="oneweb">ðŸ‡¬ðŸ‡§ OneWeb</option>
    <option value="kuiper">ðŸ‡ºðŸ‡¸ Kuiper</option>
    <option value="starlink">ðŸ‡ºðŸ‡¸ Starlink</option>
    <option value="iridium-NEXT">ðŸ‡ºðŸ‡¸ Iridium-NEXT</option>
    <option value="hulianwang">ðŸ‡¨ðŸ‡³ Hulianwang</option>
    <option value="qianfan">ðŸ‡¨ðŸ‡³ Qianfan</option>
    <option value="planet">ðŸ‡ºðŸ‡¸ Planet</option>
  </select>
  <button id="orbit-btn" onclick="goToOrbitAnalysis()">Orbit Analysis</button>
</div>

<div id="chart"></div>

<script type="module">
import * as satellite from 'https://esm.sh/satellite.js';

const orbitBtn = document.getElementById('orbit-btn');
const select = document.getElementById('constellation-select');

const TLE_URLS = {
  starlink: 'https://celestrak.org/NORAD/elements/gp.php?GROUP=starlink&FORMAT=tle',
  kuiper: 'https://celestrak.org/NORAD/elements/gp.php?GROUP=kuiper&FORMAT=tle',
  oneweb: 'https://celestrak.org/NORAD/elements/gp.php?GROUP=oneweb&FORMAT=tle',
  "iridium-NEXT": 'https://celestrak.org/NORAD/elements/gp.php?GROUP=iridium-NEXT&FORMAT=tle',
  hulianwang: 'https://celestrak.org/NORAD/elements/gp.php?GROUP=hulianwang&FORMAT=tle',
  qianfan: 'https://celestrak.org/NORAD/elements/gp.php?GROUP=qianfan&FORMAT=tle',
  planet: 'https://celestrak.org/NORAD/elements/gp.php?GROUP=planet&FORMAT=tle'
};

const EARTH_RADIUS_KM = 6371;
const TIME_STEP = 1000;
let time = new Date();
const satDataMap = {}; // Stores satellites per constellation

// Orbit button logic
function updateOrbitButton() {
  if (select.value === 'all') {
    orbitBtn.disabled = true;
    orbitBtn.style.opacity = 0.5;
  } else {
    orbitBtn.disabled = false;
    orbitBtn.style.opacity = 1;
  }
}
updateOrbitButton();
select.addEventListener('change', updateOrbitButton);

function goToOrbitAnalysis() {
  const folder = select.value;
  if (folder !== 'all') window.location.href = folder + '/index2.html';
}

// Initialize Globe
const world = Globe()(document.getElementById('chart'))
  .globeImageUrl('//cdn.jsdelivr.net/npm/three-globe/example/img/earth-night.jpg')
  .backgroundColor('#000')
  .showAtmosphere(true)
  .atmosphereColor('rgba(70, 120, 180, 0.3)')
  .particleLat('lat')
  .particleLng('lng')
  .particleAltitude('alt')
  .particlesColor(() => 'orange');

// Fetch TLE for a single constellation
async function fetchConstellation(name) {
  if (satDataMap[name]) return; // Already fetched
  const res = await fetch(TLE_URLS[name]);
  const raw = await res.text();
  const tleData = raw.replace(/\r/g, '').split(/\n(?=[^12])/).filter(d => d).map(tle => tle.split('\n'));
  const sats = tleData.map(([name, ...tle]) => ({
    satrec: satellite.twoline2satrec(...tle),
    name: name.trim().replace(/^0 /, '')
  }));
  satDataMap[name] = sats;
}

// Update positions for all satellites
function updateSatPositions() {
  time = new Date(+time + TIME_STEP);
  const gmst = satellite.gstime(time);

  Object.values(satDataMap).flat().forEach(d => {
    const eci = satellite.propagate(d.satrec, time);
    if (eci?.position) {
      const gdPos = satellite.eciToGeodetic(eci.position, gmst);
      d.lat = satellite.radiansToDegrees(gdPos.latitude);
      d.lng = satellite.radiansToDegrees(gdPos.longitude);
      d.alt = gdPos.height / EARTH_RADIUS_KM;
    } else {
      d.lat = NaN; d.lng = NaN; d.alt = NaN;
    }
  });

  // Determine which satellites to display
  let activeData;
  if (select.value === 'all') {
    activeData = Object.values(satDataMap).flat();
  } else {
    activeData = satDataMap[select.value] || [];
  }

  activeData = activeData.filter(d => !isNaN(d.lat) && !isNaN(d.lng) && !isNaN(d.alt));
  world.particlesData(activeData);
}

// Animation loop
(function frameTicker() {
  requestAnimationFrame(frameTicker);
  updateSatPositions();
})();

// Fetch all TLEs initially
Object.keys(TLE_URLS).forEach(fetchConstellation);

</script>
</body>
</html>
